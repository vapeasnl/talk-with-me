{% extends "base.html" %}

{% block title %}Story #{{ story['id'] }} | {% endblock %}

{% block body %}

<div class="view-content">
    <div class="post cit_395664">
      <div class="user-info">
    <img src="{{ url_for('static', filename=story.author.profile_picture_url if story.author.profile_picture_url else 'default_avatar.png') }}" alt="User Avatar" class="img-thumbnail">
    <span>{{ story.author.username }}</span>
    </div>
        <span class="number"><a href="#">#{{ story['id'] }}</a></span>
        <span class="title">{{ story.title }}</span>
        <span class="time">{{ story['datetime'] }}</span>
        <span class="post_id">
            [
            <span class="votes">
                <i class="bi bi-hand-thumbs-up like-button" data-id="{{ story['id'] }}" data-type="story" data-from="story" aria-label="Like"></i>
            </span>
            <span class="rating" id="like-count-{{ story['id'] }}">{{ story['likes'] }}</span>
            <span class="votes">
                <i class="bi bi-hand-thumbs-down dislike-button" data-id="{{ story['id'] }}" data-type="story" data-from="story" aria-label="Dislike"></i>
            </span>
            <span class="rating" id="dislike-count-{{ story['id'] }}">{{ story['dislikes'] }}</span>
            ]
        </span>
<div class="content">{{ story.content }}</div>
{% if story.author.id == session['user_id'] %}
    <div class="author-actions">
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#authDeleteModal" data-id="{{ story.id }}">Delete Post</button>
        <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#authEditModal" data-id="{{ story.id }}" data-title="{{ story.title }}" data-text="{{ story.text }}">Edit Post</button>
    </div>
{% endif %}

<!-- Authentication Modal for Delete -->
<div class="modal fade" id="authDeleteModal" tabindex="-1" role="dialog" aria-labelledby="authDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="authDeleteModalLabel">Authenticate to Delete Post</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="authDeleteForm">
                    <div class="form-group">
                        <label for="authUser">Username</label>
                        <input type="text" class="form-control" id="authUser" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="authPassword">Password</label>
                        <input type="password" class="form-control" id="authPassword" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Authenticate</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Authentication Modal for Edit -->
<div class="modal fade" id="authEditModal" tabindex="-1" role="dialog" aria-labelledby="authEditModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="authEditModalLabel">Authenticate to Edit Post</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="authEditForm">
                    <div class="form-group">
                        <label for="authUser">Username</label>
                        <input type="text" class="form-control" id="authUser" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="authPassword">Password</label>
                        <input type="password" class="form-control" id="authPassword" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Authenticate</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Post Modal -->
<div class="modal fade" id="deletePostModal" tabindex="-1" role="dialog" aria-labelledby="deletePostModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deletePostModalLabel">Delete Post</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this post? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <form action="/delete_post/{{ story.id }}" method="post" id="deleteForm">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Post Modal -->
<div class="modal fade" id="editPostModal" tabindex="-1" role="dialog" aria-labelledby="editPostModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPostModalLabel">Edit Post</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="/edit_post/{{ story.id }}" method="post" id="editForm">
                    <div class="form-group">
                        <label for="editTitle">Title</label>
                        <input type="text" class="form-control" id="editTitle" name="title" value="{{ story.title }}">
                    </div>
                    <div class="form-group">
                        <label for="editContent">Content</label>
                        <textarea class="form-control" id="editContent" name="content" rows="3">{{ story.text }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<h1>Comments ({{ com_count }})</h1>
<div class="view-content">
    {% if comments %}
        <div class="post cit_395664">
            {% for comment in comments %}
                <div class="comment mt-3">
                    <div class="user-info">
                        <img src="{{ url_for('static', filename=comment.user.profile_picture_url if comment.user.profile_picture_url else 'default_avatar.png') }}" alt="User Avatar" class="img-thumbnail">
                        <span>{{ comment.user.username }}</span>
                    </div>
                    <div class="content">{{ comment.text }}</div>
                    <span class="post_id">
                        [
                        <span class="votes">
                            <i class="bi bi-hand-thumbs-up like-button" data-id="{{ comment.id }}" data-type="comment" aria-label="Like"></i>
                        </span>
                        <span class="rating" id="like-count-{{ comment.id }}">{{ comment.likes }}</span>
                        <span class="votes">
                            <i class="bi bi-hand-thumbs-down dislike-button" data-id="{{ comment.id }}" data-type="comment" aria-label="Dislike"></i>
                        </span>
                        <span class="rating" id="dislike-count-{{ comment.id }}">{{ comment.dislikes }}</span>
                        ]
                    </span>
                    {% if comment.user.id == session['user_id'] %}
                        <div class="comment-actions">
                            <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteCommentModal{{ comment.id }}">Delete</button>
                            <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#editCommentModal{{ comment.id }}">Edit</button>
                        </div>
                        <!-- Delete Comment Modal -->
                        <div class="modal fade" id="deleteCommentModal{{ comment.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteCommentModalLabel{{ comment.id }}" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="deleteCommentModalLabel{{ comment.id }}">Delete Comment</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        Are you sure you want to delete this comment? This action cannot be undone.
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                        <form action="/delete_comment/{{ comment.id }}" method="post">
                                            <button type="submit" class="btn btn-danger">Delete</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Edit Comment Modal -->
                        <div class="modal fade" id="editCommentModal{{ comment.id }}" tabindex="-1" role="dialog" aria-labelledby="editCommentModalLabel{{ comment.id }}" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="editCommentModalLabel{{ comment.id }}">Edit Comment</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <form action="/edit_comment/{{ comment.id }}" method="post">
                                            <div class="form-group">
                                                <label for="editCommentContent{{ comment.id }}">Comment</label>
                                                <textarea class="form-control" id="editCommentContent{{ comment.id }}" name="content" rows="3">{{ comment.text }}</textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Save changes</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>There are no comments for this story yet. You can be the first.</p>
    {% endif %}
</div>

<br>
{% if username is none %}
    <p>You are not authorized. <a href="/login">Log in</a> or <a href="/register">register</a> to leave a comment.</p>
{% else %}
    <form action="/post/{{ story['id'] }}" method="post">
        <div class="form-group">
            <label for="commentTextarea">Comment</label>
            {% if error is none %}
                <textarea name="message" class="form-control" id="commentTextarea" rows="3"></textarea>
            {% else %}
                <textarea name="message" class="form-control is-invalid" id="commentTextarea" rows="3"></textarea>
                <div class="invalid-feedback">Please fill this field.</div>
            {% endif %}
        </div>
        <p style="margin-bottom:10px">You are authorized as <b>{{ username }}</b>.</p>
        <button type="submit" class="btn btn-primary">Leave a comment</button>
    </form>
{% endif %}

<script>
$(document).on('click', '.like-button', function() {
    let postId = $(this).data('id');
    let fromWhere = $(this).data('from');
    $.post(`/like/${postId}/${fromWhere}`, function(data) {
        if (data.success) {
            $(`#like-count-${postId}`).text(data.likes);
            $(`#dislike-count-${postId}`).text(data.dislikes);
        } else {
            console.error(data.message);
        }
    });
});

$(document).on('click', '.dislike-button', function() {
    let postId = $(this).data('id');
    let fromWhere = $(this).data('from');
    $.post(`/dislike/${postId}/${fromWhere}`, function(data) {
        if (data.success) {
            $(`#like-count-${postId}`).text(data.likes);
            $(`#dislike-count-${postId}`).text(data.dislikes);
        } else {
            console.error(data.message);
        }
    });
});

$(document).on('click', '.like-button[data-type="comment"]', function() {
    let commentId = $(this).data('id');
    $.post(`/com_like/${commentId}`, function(data) {
        if (data.success) {
            $(`#like-count-${commentId}`).text(data.likes);
            $(`#dislike-count-${commentId}`).text(data.dislikes);
        } else {
            console.error(data.message);
        }
    });
});

$(document).on('click', '.dislike-button[data-type="comment"]', function() {
    let commentId = $(this).data('id');
    $.post(`/com_dislike/${commentId}`, function(data) {
        if (data.success) {
            $(`#like-count-${commentId}`).text(data.likes);
            $(`#dislike-count-${commentId}`).text(data.dislikes);
        } else {
            console.error(data.message);
        }
    });
});
$(document).on('click', '.btn-danger[data-bs-target="#authDeleteModal"]', function() {
    $('#authDeleteModal form').attr('action', '/delete_post/' + $(this).data('id'));
});

$(document).on('click', '.btn-warning[data-bs-target="#authEditModal"]', function() {
    var post = $(this).data('post');
    $('#editPostModal form').attr('action', '/edit_post/' + post.id);
    $('#editPostModal #editTitle').val(post.title);
    $('#editPostModal #editContent').val(post.text);
});

$(document).on('submit', '#authDeleteForm', function(e) {
    e.preventDefault();
    var username = $('#authUser').val();
    var password = $('#authPassword').val();
    $.post('/authenticate', {username: username, password: password}, function(data) {
        if (data.authenticated) {
            $('#authDeleteModal').modal('hide');
            $('#deletePostModal').modal('show');
        } else {
            alert('Authentication failed');
        }
    });
});

$(document).on('submit', '#authEditForm', function(e) {
    e.preventDefault();
    var username = $('#authUser').val();
    var password = $('#authPassword').val();
    $.post('/authenticate', {username: username, password: password}, function(data) {
        if (data.authenticated) {
            $('#authEditModal').modal('hide');
            $('#editPostModal').modal('show');
        } else {
            alert('Authentication failed');
        }
    });
});
</script>
{% endblock %}
